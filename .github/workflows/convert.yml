name: Convert Model Fixed
on: [push]
jobs:
  convert-model:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install TensorFlow
        run: pip install tensorflow-cpu
        
      - name: Convert h5 to tflite (With Fix)
        shell: python
        run: |
          import tensorflow as tf
          import os

          print("Defining Patch for DepthwiseConv2D...")
          # --- THE FIX ---
          class FixedDepthwiseConv2D(tf.keras.layers.DepthwiseConv2D):
              def __init__(self, **kwargs):
                  kwargs.pop('groups', None) # Remove the specific error cause
                  super().__init__(**kwargs)
          # ----------------

          try:
              print("Loading Keras Model...")
              # Load with the custom object fix
              model = tf.keras.models.load_model(
                  'keras_model.h5', 
                  compile=False,
                  custom_objects={'DepthwiseConv2D': FixedDepthwiseConv2D}
              )

              print("Converting to TFLite...")
              converter = tf.lite.TFLiteConverter.from_keras_model(model)
              tflite_model = converter.convert()

              print("Saving model.tflite...")
              with open('model.tflite', 'wb') as f:
                  f.write(tflite_model)
              
              print("Conversion Successful!")
              
          except Exception as e:
              print(f"Error occurred: {e}")
              exit(1)
          
      - name: Upload TFLite File
        uses: actions/upload-artifact@v4
        with:
          name: converted-model
          path: model.tflite
